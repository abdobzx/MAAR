#!/bin/bash

# Script de d√©marrage rapide pour le syst√®me RAG Enterprise
# Usage: ./quick-start.sh [environment]

set -euo pipefail

ENVIRONMENT=${1:-development}
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$SCRIPT_DIR"

# Couleurs
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_section() {
    echo ""
    echo -e "${BLUE}===============================================${NC}"
    echo -e "${BLUE}  $1${NC}"
    echo -e "${BLUE}===============================================${NC}"
}

check_requirements() {
    log_section "V√âRIFICATION DES PR√âREQUIS"
    
    local missing_tools=()
    
    # V√©rifier Docker
    if ! command -v docker &> /dev/null; then
        missing_tools+=("docker")
    else
        log_info "Docker: ‚úì $(docker --version | cut -d' ' -f3)"
    fi
    
    # V√©rifier Docker Compose
    if ! command -v docker-compose &> /dev/null; then
        missing_tools+=("docker-compose")
    else
        log_info "Docker Compose: ‚úì $(docker-compose --version | cut -d' ' -f3)"
    fi
    
    # V√©rifier Python
    if ! command -v python3 &> /dev/null; then
        missing_tools+=("python3")
    else
        python_version=$(python3 --version | cut -d' ' -f2)
        log_info "Python: ‚úì $python_version"
        
        # V√©rifier la version Python
        if [[ "$python_version" < "3.11" ]]; then
            log_warn "Python 3.11+ recommand√© (version actuelle: $python_version)"
        fi
    fi
    
    # V√©rifier pip
    if ! command -v pip3 &> /dev/null; then
        missing_tools+=("pip3")
    else
        log_info "Pip: ‚úì $(pip3 --version | cut -d' ' -f2)"
    fi
    
    if [ ${#missing_tools[@]} -gt 0 ]; then
        log_error "Outils manquants: ${missing_tools[*]}"
        echo ""
        echo "Installation requise:"
        echo "  - Docker: https://docs.docker.com/get-docker/"
        echo "  - Docker Compose: https://docs.docker.com/compose/install/"
        echo "  - Python 3.11+: https://www.python.org/downloads/"
        exit 1
    fi
    
    log_info "Tous les pr√©requis sont install√©s ‚úì"
}

setup_environment() {
    log_section "CONFIGURATION DE L'ENVIRONNEMENT"
    
    cd "$PROJECT_ROOT"
    
    # Cr√©er le fichier .env si n√©cessaire
    if [ ! -f ".env.$ENVIRONMENT" ]; then
        if [ -f ".env.example" ]; then
            log_info "Cr√©ation du fichier .env.$ENVIRONMENT depuis .env.example"
            cp .env.example ".env.$ENVIRONMENT"
            
            # G√©n√©ration de cl√©s al√©atoires pour le d√©veloppement
            if [ "$ENVIRONMENT" = "development" ]; then
                log_info "G√©n√©ration de cl√©s de d√©veloppement..."
                
                # Cl√© secr√®te
                SECRET_KEY=$(openssl rand -hex 32)
                sed -i.bak "s/your-super-secret-key-change-this-in-production/$SECRET_KEY/" ".env.$ENVIRONMENT"
                
                # Cl√© de chiffrement
                ENCRYPTION_KEY=$(openssl rand -hex 16)
                sed -i.bak "s/your-encryption-key-32-chars-long/$ENCRYPTION_KEY/" ".env.$ENVIRONMENT"
                
                # Mots de passe par d√©faut
                sed -i.bak "s/your-postgres-password/postgres_dev_password/" ".env.$ENVIRONMENT"
                sed -i.bak "s/your-redis-password/redis_dev_password/" ".env.$ENVIRONMENT"
                
                rm -f ".env.$ENVIRONMENT.bak"
                
                log_warn "‚ö†Ô∏è  Cl√©s g√©n√©r√©es automatiquement pour le d√©veloppement"
                log_warn "‚ö†Ô∏è  Ne pas utiliser en production !"
            fi
        else
            log_error "Fichier .env.example manquant"
            exit 1
        fi
    else
        log_info "Fichier .env.$ENVIRONMENT existe d√©j√†"
    fi
    
    # V√©rifier les cl√©s API
    log_info "V√©rification de la configuration..."
    
    if grep -q "sk-your-openai-api-key" ".env.$ENVIRONMENT"; then
        log_warn "‚ö†Ô∏è  Cl√© OpenAI non configur√©e (optionnel pour le d√©veloppement)"
    fi
    
    if grep -q "your-cohere-api-key" ".env.$ENVIRONMENT"; then
        log_warn "‚ö†Ô∏è  Cl√© Cohere non configur√©e (optionnel pour le d√©veloppement)"
    fi
}

start_services() {
    log_section "D√âMARRAGE DES SERVICES"
    
    cd "$PROJECT_ROOT"
    
    log_info "Arr√™t des services existants..."
    docker-compose down -v 2>/dev/null || true
    
    # S√©lection du fichier compose selon l'environnement
    local compose_files="-f docker-compose.yml"
    
    case "$ENVIRONMENT" in
        "development")
            compose_files="$compose_files -f docker-compose.dev.yml"
            ;;
        "staging")
            compose_files="$compose_files -f docker-compose.staging.yml"
            ;;
        "production")
            log_error "Utiliser les scripts de d√©ploiement Kubernetes pour la production"
            exit 1
            ;;
    esac
    
    log_info "D√©marrage des services ($ENVIRONMENT)..."
    
    # Pull des images
    log_info "T√©l√©chargement des images Docker..."
    docker-compose $compose_files pull
    
    # D√©marrage des services de base
    log_info "D√©marrage des services de base..."
    docker-compose $compose_files up -d postgres redis qdrant minio
    
    # Attente que les services soient pr√™ts
    log_info "Attente que les services soient pr√™ts..."
    sleep 30
    
    # V√©rification de la connectivit√©
    check_services_health
    
    # D√©marrage de l'application
    log_info "D√©marrage de l'application RAG..."
    docker-compose $compose_files up -d
    
    # Attente finale
    sleep 20
    
    log_info "Services d√©marr√©s avec succ√®s ‚úì"
}

check_services_health() {
    log_info "V√©rification de l'√©tat des services..."
    
    local max_attempts=30
    local attempt=1
    
    while [ $attempt -le $max_attempts ]; do
        local all_healthy=true
        
        # PostgreSQL
        if ! docker-compose exec -T postgres pg_isready -U postgres &>/dev/null; then
            all_healthy=false
        fi
        
        # Redis
        if ! docker-compose exec -T redis redis-cli ping &>/dev/null; then
            all_healthy=false
        fi
        
        # Qdrant
        if ! curl -s http://localhost:6333/health &>/dev/null; then
            all_healthy=false
        fi
        
        # MinIO
        if ! curl -s http://localhost:9000/minio/health/live &>/dev/null; then
            all_healthy=false
        fi
        
        if [ "$all_healthy" = true ]; then
            log_info "Tous les services sont op√©rationnels ‚úì"
            return 0
        fi
        
        echo -n "."
        sleep 2
        ((attempt++))
    done
    
    log_error "Timeout: certains services ne r√©pondent pas"
    docker-compose ps
    return 1
}

verify_installation() {
    log_section "V√âRIFICATION DE L'INSTALLATION"
    
    log_info "Test de l'API principale..."
    
    local max_attempts=30
    local attempt=1
    
    while [ $attempt -le $max_attempts ]; do
        if curl -s http://localhost:8000/health &>/dev/null; then
            log_info "API principale: ‚úì Op√©rationnelle"
            break
        fi
        
        if [ $attempt -eq $max_attempts ]; then
            log_error "API principale: ‚úó Non accessible"
            log_error "Logs de l'API:"
            docker-compose logs --tail=20 rag-api
            return 1
        fi
        
        echo -n "."
        sleep 2
        ((attempt++))
    done
    
    # Test de l'endpoint de sant√©
    log_info "Test des endpoints critiques..."
    
    local health_response=$(curl -s http://localhost:8000/health)
    if echo "$health_response" | grep -q '"status":"healthy"'; then
        log_info "Endpoint /health: ‚úì"
    else
        log_warn "Endpoint /health: ‚ö†Ô∏è R√©ponse inattendue"
    fi
    
    log_info "Installation v√©rifi√©e avec succ√®s ‚úì"
}

show_summary() {
    log_section "SYST√àME RAG ENTERPRISE - PR√äT"
    
    echo ""
    log_info "üéâ Le syst√®me RAG Enterprise est op√©rationnel !"
    echo ""
    echo "üìç URLs d'acc√®s:"
    echo "   ‚Ä¢ API Documentation: http://localhost:8000/docs"
    echo "   ‚Ä¢ Interface Swagger: http://localhost:8000/redoc"
    echo "   ‚Ä¢ Health Check: http://localhost:8000/health"
    echo ""
    echo "üóÑÔ∏è  Interfaces d'administration:"
    echo "   ‚Ä¢ MinIO Console: http://localhost:9001 (admin/password)"
    echo "   ‚Ä¢ Qdrant Dashboard: http://localhost:6333/dashboard"
    echo ""
    echo "üîß Commandes utiles:"
    echo "   ‚Ä¢ Logs en temps r√©el: docker-compose logs -f"
    echo "   ‚Ä¢ Statut des services: docker-compose ps"
    echo "   ‚Ä¢ Arr√™ter le syst√®me: docker-compose down"
    echo ""
    echo "üìö Documentation:"
    echo "   ‚Ä¢ Guide utilisateur: docs/user-guide.md"
    echo "   ‚Ä¢ Documentation API: docs/api.md"
    echo "   ‚Ä¢ Guide de d√©ploiement: docs/deployment-guide.md"
    echo ""
    
    if [ "$ENVIRONMENT" = "development" ]; then
        log_warn "‚ö†Ô∏è  Environnement de d√©veloppement"
        log_warn "‚ö†Ô∏è  Ne pas utiliser en production"
        echo ""
        echo "üöÄ Pour la production:"
        echo "   ‚Ä¢ Voir docs/production-deployment-guide.md"
        echo "   ‚Ä¢ Utiliser Kubernetes avec ./scripts/deployment/deploy.sh"
    fi
    
    echo ""
    log_info "üí° Pour commencer, visitez: http://localhost:8000/docs"
}

# Fonction d'aide
show_help() {
    echo "Usage: $0 [environment]"
    echo ""
    echo "D√©marrage rapide du syst√®me RAG Enterprise"
    echo ""
    echo "Environnements:"
    echo "  development    D√©veloppement local (d√©faut)"
    echo "  staging        Environnement de test"
    echo ""
    echo "Options:"
    echo "  -h, --help     Affiche cette aide"
    echo ""
    echo "Exemples:"
    echo "  $0                    # D√©marrage en d√©veloppement"
    echo "  $0 development        # D√©marrage en d√©veloppement"
    echo "  $0 staging            # D√©marrage en staging"
}

# Gestion des arguments
case "${1:-}" in
    -h|--help)
        show_help
        exit 0
        ;;
    development|staging|"")
        ENVIRONMENT=${1:-development}
        ;;
    *)
        log_error "Environnement inconnu: $1"
        show_help
        exit 1
        ;;
esac

# Fonction de nettoyage en cas d'interruption
cleanup() {
    if [ $? -ne 0 ]; then
        log_error "D√©marrage interrompu"
        log_info "Nettoyage en cours..."
        docker-compose down -v 2>/dev/null || true
    fi
}

trap cleanup EXIT

# Ex√©cution principale
main() {
    echo -e "${BLUE}"
    echo "‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó"
    echo "‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo "‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ñà‚ïó    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  "
    echo "‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë    ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïù ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  "
    echo "‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó"
    echo "‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù     ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïù   ‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo -e "${NC}"
    echo ""
    log_info "Environnement: $ENVIRONMENT"
    echo ""
    
    check_requirements
    setup_environment
    start_services
    verify_installation
    show_summary
    
    log_info "üéØ D√©marrage termin√© avec succ√®s !"
}

# Ex√©cution
main "$@"
